<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GagSimulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #3d5a55;
            --bg-container: #795548;
            --border-dark: #4e342e;
            --text-light: #ffffff;
            --item-bg-dark: #a1887f;
            --item-bg-light: #d7ccc8;
            --item-border: #8d6e63;
        }
        html, body {
             overscroll-behavior: none;
             background-color: var(--bg-main);
        }
        body {
            font-family: 'Press Start 2P', cursive;
            color: var(--text-light);
            text-shadow: 1px 1px #000000;
        }
        .inventory-container, .modal-content {
            background-color: var(--bg-container);
            background-image: url('https://devforum-uploads.s3.dualstack.us-east-2.amazonaws.com/uploads/optimized/5X/c/b/2/9/cb293d819c45f471372ce6abe9975205ffff063b_2_500x500.png');
            background-size: 80px;
            border: 4px solid var(--border-dark);
            border-radius: 12px;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
        }
        .btn {
            transition: all 0.2s ease;
            border-radius: 8px;
            text-shadow: 1px 1px #000;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn:active { transform: translateY(1px); border-bottom-width: 4px; }
        
        .btn-red { background-color: #f44336; color: white; border: 2px solid #d32f2f; border-bottom-width: 5px; }
        .btn-blue { background-color: #2196F3; color: white; border: 2px solid #1976D2; border-bottom-width: 5px; }
        .btn-green { background-color: #4CAF50; color: white; border: 2px solid #388E3C; border-bottom-width: 5px; }
        .btn-tab { background-color: #6d4c41; color: #d7ccc8; border: 2px solid #4e342e; border-bottom-width: 5px;}
        .btn-tab.active { background-color: #a1887f; color: white; border-color: #5d4037; }


        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); z-index: 1000; }
        
        @keyframes rainbow-animation { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        @keyframes divine-animation { 0% { color: #ff9900; text-shadow: 0 0 8px #ff9900, 0 0 16px #fff; } 50% { color: #ffffff; text-shadow: 0 0 12px #fff, 0 0 20px #ff9900; } 100% { color: #ff9900; text-shadow: 0 0 8px #ff9900, 0 0 16px #fff; } }

        .rarity-Divine { animation: divine-animation 2s linear infinite; }
        .rarity-Prismatic { background: linear-gradient(90deg, #ff6666, #ffff66, #66ff66, #66ffff, #6666ff, #ff66ff, #ff6666); background-size: 400% auto; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow-animation 4s linear infinite; text-shadow: none; }
        .rarity-Mythical { color: #FF00FF; }
        .rarity-Legendary { color: #FFD700; }
        .rarity-Rare { color: #00BFFF; }
        .rarity-Uncommon { color: #32CD32; }
        .rarity-Common { color: #FFFFFF; }
        .rarity-Event { color: #ff7f50; }

        .inventory-item { position: relative; background-color: var(--item-bg-dark); border: 2px solid var(--border-dark); cursor: pointer; transition: all 0.2s ease; opacity: 1; }
        .inventory-item:hover { transform: scale(1.05); border-color: #c7a500; }
        .inventory-item.disabled { cursor: not-allowed; opacity: 0.5; }
        .item-count { position: absolute; bottom: 1px; right: 2px; font-size: 0.7rem; font-weight: bold; text-shadow: 1px 1px 1px #000, -1px -1px 1px #000; }
        .delete-item-button { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: #f44336; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; line-height: 1rem; font-weight: bold; cursor: pointer; border: 1px solid white; z-index: 11; opacity: 0; transition: opacity 0.2s; }
        .inventory-item:hover .delete-item-button { opacity: 1; }
        
        #sound-toggle { position: fixed; top: 10px; right: 10px; z-index: 999; font-size: 1.5rem; cursor: pointer; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px; }

        .scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 1rem;
        }
        .scroll-container::-webkit-scrollbar { height: 8px; }
        .scroll-container::-webkit-scrollbar-track { background: var(--border-dark); border-radius: 4px; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--item-border); border-radius: 4px; }
        .scroll-container #inventory-grid {
            display: inline-flex;
            gap: 0.5rem;
        }
        .info-button {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background-color: #2196F3;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            line-height: 1rem;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid white;
            z-index: 10;
        }

        #trade-modal .modal-content { background-color: #5d4037; }
        .trade-grid { display: grid; grid-template-columns: 1fr; gap: 0.5rem; }
        @media (min-width: 768px) { .trade-grid { grid-template-columns: 1fr auto 1fr; align-items: center; gap: 1rem; } }
        .trade-area { background-color: var(--item-bg-dark); border: 2px solid var(--border-dark); border-radius: 8px; padding: 0.5rem; min-height: 180px; }
        .trade-item-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .trade-item { border: 2px solid var(--item-border); background-color: var(--item-bg-light); cursor: pointer; height: 80px; }
        .trade-item.placeholder { display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: var(--item-border); background-color: rgba(0,0,0,0.1); transition: background-color 0.2s; }
        .trade-item.placeholder:hover { background-color: rgba(0,0,0,0.2); }
        
    </style>
</head>
<body class="p-2 md:p-4">
    
    <div id="main-content">
        <div id="sound-toggle">üîá</div>

        <div class="max-w-7xl mx-auto">
            <div class="inventory-container p-2 md:p-4 rounded-lg mb-4">
                 <h2 class="text-md md:text-xl font-bold mb-2 text-center border-b-2 border-b-stone-800 pb-1">–û–¢–ö–†–´–¢–¨</h2>
                 <div class="scroll-container">
                    <div id="inventory-grid"></div>
                 </div>
            </div>

            <div class="inventory-container p-2 md:p-4 rounded-lg mb-4">
                <h2 class="text-md md:text-xl font-bold mb-2 text-center border-b-2 border-b-stone-800 pb-1">–ú–ê–°–°–û–í–û–ï –û–¢–ö–†–´–¢–ò–ï</h2>
                <div class="flex flex-col sm:flex-row items-stretch justify-center gap-2 p-2">
                    <select id="bulk-open-select" class="w-full sm:w-auto flex-grow rounded-md bg-stone-300 text-black text-sm p-2 border-2 border-stone-600"></select>
                    <input type="number" id="bulk-quantity-input" class="w-full sm:w-20 rounded-md bg-stone-300 text-black text-center p-2 border-2 border-stone-600" value="10" min="1" max="10000">
                    <button id="bulk-open-button" class="btn btn-green w-full sm:w-auto">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
            </div>

            <div class="inventory-container p-2 md:p-4 rounded-lg mb-4">
                <h2 class="text-md md:text-xl font-bold mb-2 text-center border-b-2 border-b-stone-800 pb-1">–¢–†–ï–ô–î–´</h2>
                 <div class="text-center">
                    <button id="open-trade-sim-button" class="btn btn-blue">–°–∏–º—É–ª—è—Ç–æ—Ä –¢—Ä–µ–π–¥–æ–≤</button>
                </div>
            </div>

            <div class="inventory-container p-2 md:p-4 rounded-lg mb-4">
                <div class="flex justify-between items-center border-b-2 border-b-stone-800 pb-1 mb-2">
                    <div class="flex gap-2">
                        <button id="show-pets-btn" class="btn btn-tab active">–ü–∏—Ç–æ–º—Ü—ã</button>
                        <button id="show-seeds-btn" class="btn btn-tab">–°–µ–º–µ–Ω–∞</button>
                    </div>
                </div>
                <div id="collected-pets-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 min-h-[100px]"></div>
                <div id="collected-seeds-grid" class="hidden grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 min-h-[100px]"></div>
            </div>

            <div class="text-center mt-4">
                <button id="clear-inventory-button" class="btn btn-red">–û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="result-modal" class="fixed inset-0 flex items-center justify-center p-4 modal-backdrop hidden" style="z-index: 1010;">
        <div id="modal-content" class="modal-content w-full max-w-lg p-4 rounded-lg text-center relative">
            <h2 id="modal-title" class="text-lg font-bold mb-2"></h2>
            <div id="simple-result-view" class="hidden my-4 flex justify-center"><div id="result-image-container" class="w-32 h-32"></div></div>
            <div id="controls-and-result-area" class="mt-2 min-h-[100px] flex flex-col justify-center items-center">
                <div id="final-result-display" class="hidden w-full">
                     <p id="result-name" class="text-xl font-bold mb-1"></p>
                     <p id="result-rarity" class="text-md font-semibold mb-4"></p>
                     <button id="close-modal-button" class="btn btn-blue font-bold">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                <button id="skip-button" class="btn btn-red font-bold hidden">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div id="trade-modal" class="fixed inset-0 flex-col items-center justify-center p-2 modal-backdrop hidden" style="z-index: 1010;">
        <div class="modal-content w-full max-w-6xl p-2 md:p-4 rounded-lg text-center relative">
             <button id="close-trade-modal-button" class="absolute top-2 right-2 btn btn-blue !p-2 w-12 h-12 flex items-center justify-center text-2xl font-bold !border-0 z-10">√ó</button>
            <h2 class="text-lg md:text-xl font-bold mb-2">–°–ò–ú–£–õ–Ø–¢–û–† –¢–†–ï–ô–î–û–í</h2>
            
            <div class="trade-grid mb-2">
                <div class="trade-area">
                    <h3 class="text-sm font-bold mb-1 border-b border-b-stone-600 pb-1">–í–ê–®–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï</h3>
                    <div id="player-offer-grid" class="trade-item-grid"></div>
                </div>
                <div class="flex items-center justify-center text-2xl md:text-4xl font-bold text-stone-400 my-1 md:my-0">&#x21C4;</div>
                <div class="trade-area">
                    <h3 class="text-sm font-bold mb-1 border-b border-b-stone-600 pb-1">–ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ë–û–¢–ê</h3>
                    <div id="bot-offer-grid" class="trade-item-grid"></div>
                </div>
            </div>

            <div id="trade-actions" class="flex justify-center gap-4 my-2">
                <button id="decline-trade-button" class="btn btn-red">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                <button id="accept-trade-button" class="btn btn-green">–ü—Ä–∏–Ω—è—Ç—å</button>
            </div>
        </div>

        <div id="trade-result-modal" class="absolute inset-0 flex items-center justify-center p-4 modal-backdrop hidden" style="z-index: 1020;">
             <div class="modal-content w-full max-w-sm p-4 rounded-lg text-center relative">
                <h3 id="trade-result-title" class="text-xl font-bold mb-2"></h3>
                <p id="trade-result-details" class="text-sm mb-1"></p>
                <p id="trade-result-percentage" class="text-3xl font-bold mb-4"></p>
                <div id="trade-result-actions" class="flex justify-center gap-4">
                   <button id="back-to-trade-button" class="btn btn-red">–ù–∞–∑–∞–¥</button>
                   <button id="confirm-trade-button" class="btn btn-green">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </div>
                 <button id="close-trade-result-button" class="btn btn-blue mt-4 hidden">OK</button>
            </div>
        </div>
    </div>

    <div id="pet-selection-modal" class="fixed inset-0 flex items-center justify-center p-4 modal-backdrop hidden" style="z-index: 1020;">
        <div class="modal-content w-full max-w-4xl p-4 rounded-lg text-center relative">
            <button id="close-pet-selection-modal-button" class="absolute top-2 right-2 btn btn-blue !p-1 w-8 h-8 flex items-center justify-center text-lg font-bold !border-0">√ó</button>
            <h2 class="text-lg font-bold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Ç–æ–º—Ü–∞ –¥–ª—è –æ–±–º–µ–Ω–∞</h2>
            <div id="pet-selection-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 max-h-80 overflow-y-auto p-2 bg-black bg-opacity-25 rounded-lg"></div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 flex items-center justify-center p-4 modal-backdrop hidden" style="z-index: 1010;">
        <div class="modal-content w-full max-w-2xl p-4 rounded-lg text-center relative">
            <button id="close-info-modal-button" class="absolute top-2 right-2 btn btn-blue !p-1 w-8 h-8 flex items-center justify-center text-lg font-bold !border-0">√ó</button>
            <h2 id="info-modal-title" class="text-lg font-bold mb-4">–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã</h2>
            <div id="info-modal-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-80 overflow-y-auto p-2 bg-black bg-opacity-25 rounded-lg"></div>
        </div>
    </div>


    <script>
        const rarityOrder = ['Common', 'Uncommon', 'Rare', 'Legendary', 'Mythical', 'Prismatic', 'Divine', 'Event'];
        
        const allItemData = {
            'egg': { id: 'egg', name: 'Zen Egg', rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/1/14/Zeneg.png/revision/latest', type: 'egg', items: [
                { name: 'Shiba Inu', type: 'animal', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/b/bb/Shiba_Inu.png/revision/latest' },
                { name: 'Nihonzaru', type: 'animal', chance: 31, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/d/db/Nihonzaru_.png/revision/latest' },
                { name: 'Tanuki', type: 'animal', chance: 20.82, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/1/1f/Tanuki_.png/revision/latest' },
                { name: 'Tanchozuru', type: 'animal', chance: 4.6, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/d/d3/Tanchozuru_.png/revision/latest' },
                { name: 'Kappa', type: 'animal', chance: 3.5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/8/84/Kappa_.png/revision/latest' },
                { name: 'Kitsune', type: 'animal', chance: 0.08, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/4/4d/Kitsune_.png/revision/latest' }
            ]},
            'seed': { id: 'seed', name: 'Exotic Zen Seed Pack', rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/8/85/ExoticZenSeedPack.png/revision/latest', type: 'seed', items: [
                { name: 'Monoblooma', type: 'seed', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/a/ad/MonobloomaCrop.png/revision/latest' },
                { name: 'Serenity', type: 'seed', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/d/d9/SerenityCrop.png/revision/latest' },
                { name: 'Taro Flower', type: 'seed', chance: 20, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a1/TaroFlowerCrop.png/revision/latest' },
                { name: 'Zen Rocks', type: 'seed', chance: 10, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/c/c9/ZenRocksCrop.png/revision/latest' },
                { name: 'Hinomai', type: 'seed', chance: 4.5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/4/41/HinomaiCrop.png/revision/latest' },
                { name: 'Maple Apple', type: 'seed', chance: 0.5, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/7/7f/MapleAppleCrop.png/revision/latest' }
            ]},
            'bug': { id: 'bug', name: 'Bug Egg', rarity: 'Divine', rarityClass: 'rarity-Divine', image: 'https://static.wikia.nocookie.net/growagarden/images/8/86/Bugeggimage.png/revision/latest', type: 'egg', items: [
                { name: 'Caterpillar', type: 'bug', chance: 40, rarity: 'Common', rarityClass: 'rarity-Common', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a4/Caterpillar_no_back.png/revision/latest' },
                { name: 'Snail', type: 'bug', chance: 30, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/d/d2/Snail_Icon.png/revision/latest' },
                { name: 'Giant Ant', type: 'bug', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/f/ff/Ant_4.png/revision/latest' },
                { name: 'Praying Mantis', type: 'bug', chance: 4, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/2/25/PrayingMantis.png/revision/latest' },
                { name: 'Dragonfly', type: 'bug', chance: 1, rarity: 'Divine', rarityClass: 'rarity-Divine', image: 'https://static.wikia.nocookie.net/growagarden/images/c/c9/DragonflyIcon.png/revision/latest' }
            ]},
            'normal_seed': { id: 'normal_seed', name: 'Normal Seed Pack', rarity: 'Common', rarityClass: 'rarity-Common', image: 'https://static.wikia.nocookie.net/growagarden/images/c/c1/Normal_Seed_Pack.png/revision/latest', type: 'seed', items: [
                { name: 'Watermelon', type: 'normal_seed', chance: 12.5, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/3/31/Watermelonfruiticon.png/revision/latest' },
                { name: 'Pumpkin', type: 'normal_seed', chance: 12.5, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/3/36/Pumpkincropp.png/revision/latest' },
                { name: 'Cactus', type: 'normal_seed', chance: 12.5, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/8/86/Cactus_fruit_icon.png/revision/latest' },
                { name: 'Dragon Fruit', type: 'normal_seed', chance: 12.5, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/4/4a/Dragonfruitthumb.png/revision/latest' },
                { name: 'Pineapple', type: 'normal_seed', chance: 7.7, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/c/cc/PineappleFruitIcon.png/revision/latest' },
                { name: 'Peach', type: 'normal_seed', chance: 12.5, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/1/13/Transparent_Peach.png/revision/latest' },
                { name: 'Raspberry', type: 'normal_seed', chance: 12.5, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/1/1f/Raspberry.png/revision/latest' },
                { name: 'Mango', type: 'normal_seed', chance: 12.5, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/0/0e/MangoFruitIcon.png/revision/latest' }
            ]},
            'oasis_egg': { id: 'oasis_egg', name: 'Oasis Egg', rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/9/90/OasisEgg.webp/revision/latest', type: 'egg', items: [
                { name: 'Meerkat', type: 'animal', chance: 45, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/c/c2/Meerkat.png/revision/latest' },
                { name: 'Sand Snake', type: 'animal', chance: 34.5, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a4/SandSnakeIcon.png/revision/latest' },
                { name: 'Axolotl', type: 'animal', chance: 15, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/0/0f/AxolotlIcon.png/revision/latest' },
                { name: 'Hyacinth Macaw', type: 'animal', chance: 5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/7/77/HyacinthMacawIcon.png/revision/latest' },
                { name: 'Fennec Fox', type: 'animal', chance: 0.5, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/e/e8/FennecFoxIcon.png/revision/latest' }
            ]},
            'rare_summer_egg': { id: 'rare_summer_egg', name: 'Rare Summer Egg', rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/6/6c/RareSummerEgg.png/revision/latest', type: 'egg', items: [
                { name: 'Flamingo', type: 'animal', chance: 30, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/e/ec/FlamingoIcon.webp/revision/latest' },
                { name: 'Toucan', type: 'animal', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/1/10/ToucanIcon.webp/revision/latest' },
                { name: 'Sea Turtle', type: 'animal', chance: 20, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/a/ad/SeaTurtleIcon.webp/revision/latest' },
                { name: 'Orangutan', type: 'animal', chance: 15, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/4/47/OrangutanIcon.webp/revision/latest' },
                { name: 'Seal', type: 'animal', chance: 10, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/f/f9/SealIcon.webp/revision/latest' }
            ]},
            'dinosaur_egg': { id: 'dinosaur_egg', name: 'Dinosaur Egg', rarity: 'Event', rarityClass: 'rarity-Event', image: 'https://static.wikia.nocookie.net/growagarden/images/2/29/Dinosauregg.png/revision/latest', type: 'egg', items: [
                { name: 'Raptor', type: 'animal', chance: 35, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/0/08/Raptor.png/revision/latest' },
                { name: 'Triceratops', type: 'animal', chance: 32.5, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a1/Triceratops.png/revision/latest' },
                { name: 'Stegosaurus', type: 'animal', chance: 28, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/c/cd/Stegosaurus.png/revision/latest' },
                { name: 'Pterodactyl', type: 'animal', chance: 3, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/4/49/Pterodactyl.png/revision/latest' },
                { name: 'Brontosaurus', type: 'animal', chance: 1, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/4/47/Brontosaurus.png/revision/latest' },
                { name: 'T-Rex', type: 'animal', chance: 0.5, rarity: 'Divine', rarityClass: 'rarity-Divine', image: 'https://static.wikia.nocookie.net/growagarden/images/f/f8/T-Rex.png/revision/latest' }
            ]},
            'anti_bee_egg': { id: 'anti_bee_egg', name: 'Anti Bee Egg', rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/e/e2/AntiBeeEgg.png/revision/latest', type: 'egg', items: [
                { name: 'Wasp', type: 'bug', chance: 55, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/f/f8/The_Wasp.png/revision/latest' },
                { name: 'Tarantula Hawk', type: 'bug', chance: 30, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/7/78/The_Tarantula_Hawk.png/revision/latest' },
                { name: 'Moth', type: 'bug', chance: 13.75, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/0/09/Moth.png/revision/latest' },
                { name: 'Butterfly', type: 'bug', chance: 1, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/1/18/Thy_Butterfly_V2.png/revision/latest' },
                { name: 'Disco Bee', type: 'bug', chance: 0.25, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/f/f2/DiscoBeeIcon.gif/revision/latest' }
            ]},
            'night_egg': { id: 'night_egg', name: 'Night Egg', rarity: 'Event', rarityClass: 'rarity-Event', image: 'https://static.wikia.nocookie.net/growagarden/images/7/71/Night_Egg.png/revision/latest', type: 'egg', items: [
                { name: 'Hedgehog', type: 'animal', chance: 47, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/4/46/HedgehogPet.png/revision/latest' },
                { name: 'Mole', type: 'animal', chance: 23.5, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/6/63/Mole.png/revision/latest' },
                { name: 'Frog', type: 'animal', chance: 16.74, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/5/55/FrogV2.png/revision/latest' },
                { name: 'Echo Frog', type: 'animal', chance: 8.23, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/3/30/Echo_frog.png/revision/latest' },
                { name: 'Night Owl', type: 'animal', chance: 3.53, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/3/3e/NightOwlPic.png/revision/latest' },
                { name: 'Raccoon', type: 'animal', chance: 0.1, rarity: 'Divine', rarityClass: 'rarity-Divine', image: 'https://static.wikia.nocookie.net/growagarden/images/7/73/Racoon.png/revision/latest' }
            ]},
            'bee_egg': { id: 'bee_egg', name: 'Bee Egg', rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/8/8d/BeeEgg.png/revision/latest', type: 'egg', items: [
                { name: 'Bee', type: 'bug', chance: 65, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/f/f2/Beee.png/revision/latest' },
                { name: 'Honey Bee', type: 'bug', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/1/14/HoneyBee.png/revision/latest' },
                { name: 'Bear Bee', type: 'bug', chance: 5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/8/8b/Bearbeee1.png/revision/latest' },
                { name: 'Petal Bee', type: 'bug', chance: 4, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/5/52/Petalbee.png/revision/latest' },
                { name: 'Queen Bee', type: 'bug', chance: 1, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/7/7a/Queen_bee.png/revision/latest' }
            ]},
            'night_seed_pack': { id: 'night_seed_pack', name: 'Night Seed Pack', rarity: 'Event', rarityClass: 'rarity-Event', image: 'https://static.wikia.nocookie.net/growagarden/images/3/34/NightSeedPackRev.PNG/revision/latest', type: 'seed', items: [
                { name: 'Nightshade', type: 'seed', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/d/dd/Flower.png/revision/latest' },
                { name: 'Glowshroom', type: 'seed', chance: 20, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/7/75/GlowShroomFruit.png/revision/latest' },
                { name: 'Mint', type: 'seed', chance: 15, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/0/09/MintFruit.png/revision/latest' },
                { name: 'Moonflower', type: 'seed', chance: 10, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a0/MoonFlowerCropsIcon.png/revision/latest' },
                { name: 'Starfruit', type: 'seed', chance: 9.5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/6/62/StarFruitFruit.png/revision/latest' },
                { name: 'Moonglow', type: 'seed', chance: 5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/e/e0/MoonglowProduce.png/revision/latest' },
                { name: 'Moon Blossom', type: 'seed', chance: 0.5, rarity: 'Divine', rarityClass: 'rarity-Divine', image: 'https://static.wikia.nocookie.net/growagarden/images/7/77/MoonBlossomBetterQuality.png/revision/latest' }
            ]},
            'ancient_seed_pack': { id: 'ancient_seed_pack', name: 'Ancient Seed Pack', rarity: 'Event', rarityClass: 'rarity-Event', image: 'https://static.wikia.nocookie.net/growagarden/images/b/bf/AncientSeedPack1.png/revision/latest', type: 'seed', items: [
                { name: 'Stonebite', type: 'seed', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/3/39/Stonebite_Crop.png/revision/latest' },
                { name: 'Paradise Petal', type: 'seed', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/d/df/Paradise_Petal_Crop.png/revision/latest' },
                { name: 'Horned Dinoshroom', type: 'seed', chance: 20, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/9/93/Horned_Dinoshroom_Crop.png/revision/latest' },
                { name: 'Boneboo', type: 'seed', chance: 10, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/e/e7/Boneboo_Crop.png/revision/latest' },
                { name: 'Firefly Fern', type: 'seed', chance: 4.5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/d/de/Firefly_Fern_Crop.png/revision/latest' },
                { name: 'Fossilight', type: 'seed', chance: 0.5, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/7/71/Fossilight_Fruit_Crop.png/revision/latest' }
            ]},
            'summer_seed_pack': { id: 'summer_seed_pack', name: 'Summer Seed Pack', rarity: 'Event', rarityClass: 'rarity-Event', image: 'https://static.wikia.nocookie.net/growagarden/images/d/db/Summerseedpack.png/revision/latest', type: 'seed', items: [
                { name: 'Wild Carrot', type: 'seed', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/6/62/Wild_Carrot_Produce.png/revision/latest' },
                { name: 'Pear', type: 'seed', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a1/Regpear.png/revision/latest' },
                { name: 'Cantaloupe', type: 'seed', chance: 20, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/6/68/Cantaloupe.png/revision/latest' },
                { name: 'Parasol Flower', type: 'seed', chance: 10, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/b/b2/Parasol_Flower.png/revision/latest' },
                { name: 'Rosy Delight', type: 'seed', chance: 4.5, rarity: 'Divine', rarityClass: 'rarity-Divine', image: 'https://static.wikia.nocookie.net/growagarden/images/5/58/Rosy_Delight_Produce.png/revision/latest' },
                { name: 'Elephant Ears', type: 'seed', chance: 0.5, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/8/89/Elephant_Ears_Produce.png/revision/latest' }
            ]},
            'crafters_seed_pack': { id: 'crafters_seed_pack', name: 'Crafters Seed Pack', rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/3/3d/Crafters_Seed_Pack.png/revision/latest', type: 'seed', items: [
                { name: 'Crocus', type: 'seed', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/2/2f/Crocus.png/revision/latest' },
                { name: 'Succulent', type: 'seed', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/4/46/Succulent1.png/revision/latest' },
                { name: 'Violet Corn', type: 'seed', chance: 20, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/e/e5/VioletCornIcon.png/revision/latest' },
                { name: 'Bendboo', type: 'seed', chance: 10, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/6/62/BendbooPlantIcon.png/revision/latest' },
                { name: 'Cocovine', type: 'seed', chance: 4.5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/c/c1/Cocovine_Crop.png/revision/latest' },
                { name: 'Dragon Pepper', type: 'seed', chance: 0.5, rarity: 'Divine', rarityClass: 'rarity-Divine', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a9/Dragon_pepper.png/revision/latest' }
            ]},
        };
        const allPets = Object.values(allItemData).flatMap(c => c.items).filter(i => i.type === 'animal' || i.type === 'bug');

        const dom = {
            inventoryGrid: document.getElementById('inventory-grid'),
            resultModal: document.getElementById('result-modal'),
            modalTitle: document.getElementById('modal-title'),
            skipButton: document.getElementById('skip-button'),
            simpleResultView: document.getElementById('simple-result-view'),
            resultImageContainer: document.getElementById('result-image-container'),
            finalResultDisplay: document.getElementById('final-result-display'),
            resultName: document.getElementById('result-name'),
            resultRarity: document.getElementById('result-rarity'),
            closeModalButton: document.getElementById('close-modal-button'),
            collectedPetsGrid: document.getElementById('collected-pets-grid'),
            collectedSeedsGrid: document.getElementById('collected-seeds-grid'),
            showPetsBtn: document.getElementById('show-pets-btn'),
            showSeedsBtn: document.getElementById('show-seeds-btn'),
            clearInventoryButton: document.getElementById('clear-inventory-button'),
            soundToggle: document.getElementById('sound-toggle'),
            bulkOpenSelect: document.getElementById('bulk-open-select'),
            bulkQuantityInput: document.getElementById('bulk-quantity-input'),
            bulkOpenButton: document.getElementById('bulk-open-button'),
            openTradeSimButton: document.getElementById('open-trade-sim-button'),
            tradeModal: document.getElementById('trade-modal'),
            closeTradeModalButton: document.getElementById('close-trade-modal-button'),
            botOfferGrid: document.getElementById('bot-offer-grid'),
            playerOfferGrid: document.getElementById('player-offer-grid'),
            acceptTradeButton: document.getElementById('accept-trade-button'),
            declineTradeButton: document.getElementById('decline-trade-button'),
            tradeResultModal: document.getElementById('trade-result-modal'),
            tradeResultTitle: document.getElementById('trade-result-title'),
            tradeResultDetails: document.getElementById('trade-result-details'),
            tradeResultPercentage: document.getElementById('trade-result-percentage'),
            confirmTradeButton: document.getElementById('confirm-trade-button'),
            backToTradeButton: document.getElementById('back-to-trade-button'),
            closeTradeResultButton: document.getElementById('close-trade-result-button'),
            petSelectionModal: document.getElementById('pet-selection-modal'),
            petSelectionGrid: document.getElementById('pet-selection-grid'),
            closePetSelectionModalButton: document.getElementById('close-pet-selection-modal-button'),
            infoModal: document.getElementById('info-modal'),
            infoModalTitle: document.getElementById('info-modal-title'),
            infoModalGrid: document.getElementById('info-modal-grid'),
            closeInfoModalButton: document.getElementById('close-info-modal-button'),
        };

        let state = {
            winningItem: null,
            animationTimeoutId: null,
            isOpening: false,
            collectedItems: [],
            isMuted: true,
            currentTrade: { botOffer: [], playerOffer: [] },
            activeInventory: 'pets',
        };
        const MAX_TRADE_SLOTS = 6;

        let sounds = {};
        function setupSounds() {
            try {
                sounds.click = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 0.1 } }).toDestination();
                sounds.open = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination();
                sounds.close = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                sounds.clear = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination();
                sounds.delete = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0 } }).toDestination();
                sounds.delete.volume.value = -10;
                sounds.win = new Tone.MetalSynth({ frequency: 250, envelope: { attack: 0.001, decay: 0.6, release: 0.2 }, harmonicity: 6.1, modulationIndex: 28, resonance: 3500, octaves: 1.5 }).toDestination();
                sounds.win.volume.value = -6;
                sounds.trade = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
                Tone.Destination.mute = state.isMuted;
                dom.soundToggle.textContent = state.isMuted ? 'üîá' : 'üîä';
            } catch (e) {
                console.error("Failed to initialize audio:", e);
                dom.soundToggle.style.display = 'none';
            }
        }
        function playSound(sound, note, duration = '8n') { if (!state.isMuted && sounds[sound]) { try { sounds[sound].triggerAttackRelease(note, duration, Tone.now()); } catch (e) {} } }

        function saveInventory() { localStorage.setItem('gagluck_collectedItems', JSON.stringify(state.collectedItems)); }
        function loadInventory() {
            const saved = localStorage.getItem('gagluck_collectedItems');
            if (saved) {
                try {
                    state.collectedItems = JSON.parse(saved);
                    let needsSave = false;
                    state.collectedItems.forEach((item, index) => {
                        if (!item.uniqueId) {
                            item.uniqueId = `${item.name.replace(/\s+/g, '-')}-${index}-${Date.now()}${Math.random()}`;
                            needsSave = true;
                        }
                    });
                    if (needsSave) saveInventory();
                } catch(e) { state.collectedItems = []; }
            }
            renderCollectedInventories();
        }

        function renderCollectedInventories() {
            renderInventoryGrid('pets');
            renderInventoryGrid('seeds');
        }

        function renderInventoryGrid(type) {
            const grid = type === 'pets' ? dom.collectedPetsGrid : dom.collectedSeedsGrid;
            const itemFilter = type === 'pets' 
                ? item => item.type === 'animal' || item.type === 'bug'
                : item => item.type.includes('seed');

            grid.innerHTML = '';
            const itemsToShow = state.collectedItems.filter(itemFilter);

            if (itemsToShow.length === 0) {
                const message = type === 'pets' ? '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤...' : '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–µ–º—è–Ω...';
                grid.innerHTML = `<p class="col-span-full text-center text-stone-400 text-xs">${message}</p>`;
                return;
            }

            const sortedItems = [...itemsToShow].sort((a, b) => rarityOrder.indexOf(b.rarity) - rarityOrder.indexOf(a.rarity) || a.name.localeCompare(b.name));
            
            const itemCounts = {};
            sortedItems.forEach(item => {
                if (!itemCounts[item.name]) {
                    itemCounts[item.name] = { ...item, count: 0, uniqueIds: [] };
                }
                itemCounts[item.name].count++;
                itemCounts[item.name].uniqueIds.push(item.uniqueId);
            });

            Object.values(itemCounts).forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item p-1 rounded-md flex flex-col items-center justify-between text-center h-28 bg-black bg-opacity-20';
                itemEl.innerHTML = `<div class="delete-item-button" data-item-name="${item.name}">√ó</div><img src="${item.image}" alt="${item.name}" class="h-14 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/80x80/a1887f/FFF?text=?';"><p class="text-[10px] font-bold leading-tight">${item.name}</p><p class="text-[9px] ${item.rarityClass}">[${item.rarity}]</p>${item.count > 1 ? `<div class="item-count">x${item.count}</div>` : ''}`;
                grid.appendChild(itemEl);
            });
        }


        function addItemToInventory(item) {
            state.collectedItems.push({ ...item, uniqueId: `${item.name.replace(/\s+/g, '-')}-${Date.now()}${Math.random()}` });
        }

        function getRandomItem(items) {
            const totalChance = items.reduce((sum, item) => sum + item.chance, 0);
            let random = Math.random() * totalChance;
            for (const item of items) { if (random < item.chance) return item; random -= item.chance; }
            return items[items.length - 1];
        }
        function setInventoryState(disabled) {
            state.isOpening = disabled;
            document.querySelectorAll('#inventory-grid .inventory-item').forEach(el => el.classList.toggle('disabled', disabled));
        }
        function showFinalResult(item) {
            playSound('win', 'C5');
            addItemToInventory(item);
            saveInventory();
            renderCollectedInventories();
            dom.resultName.textContent = item.name;
            dom.resultRarity.innerHTML = `[${item.rarity}]`;
            dom.resultRarity.className = `text-md font-semibold ${item.rarityClass}`;
            dom.skipButton.classList.add('hidden');
            dom.finalResultDisplay.classList.remove('hidden');
        }
        function closeModal(modalElement) {
            playSound('close', 'A3');
            modalElement.classList.add('hidden');
            setInventoryState(false);
            if (modalElement === dom.resultModal) {
                 clearTimeout(state.animationTimeoutId);
            }
        }
        function handleSingleOpen(type) {
            if (state.isOpening) return;
            playSound('click', 'C5');
            setInventoryState(true);
            const currentItemData = allItemData[type];
            state.winningItem = getRandomItem(currentItemData.items);
            dom.modalTitle.textContent = `–û—Ç–∫—Ä—ã—Ç–∏–µ ${currentItemData.name}...`;
            dom.finalResultDisplay.classList.add('hidden');
            dom.skipButton.classList.remove('hidden');
            dom.resultModal.classList.remove('hidden');
            dom.resultModal.classList.add('flex');
            playSound('open', 'E5');
            dom.simpleResultView.classList.remove('hidden');
            dom.resultImageContainer.innerHTML = `<img src="${state.winningItem.image}" alt="${state.winningItem.name}" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/100x100/795548/FFF?text=?';">`;
            state.animationTimeoutId = setTimeout(() => { if (state.isOpening) showFinalResult(state.winningItem); }, 800);
        }
        function skipAnimation() {
            if (!state.isOpening || !state.winningItem) return;
            playSound('click', 'A4');
            clearTimeout(state.animationTimeoutId);
            showFinalResult(state.winningItem);
        }
        
        function getItemValue(item) {
            if (!item) return 0;
            const rarityValue = rarityOrder.indexOf(item.rarity) + 1;
            const chanceValue = item.chance > 0 ? 100 / item.chance : 1000;
            return rarityValue * chanceValue;
        }
        function createTradeItemElement(item, uniqueId) {
            const itemEl = document.createElement('div');
            itemEl.className = 'trade-item inventory-item p-1 rounded-md flex flex-col items-center justify-center text-center';
            itemEl.dataset.uniqueId = uniqueId;
            itemEl.dataset.name = item.name;
            itemEl.innerHTML = `<img src="${item.image}" alt="${item.name}" class="h-12 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/80x80/d7ccc8/FFF?text=?';"><p class="text-[9px] font-bold leading-tight mt-1">${item.name}</p><p class="text-[8px] ${item.rarityClass}">[${item.rarity}]</p>`;
            return itemEl;
        }
        function startNewTrade() {
            playSound('trade', 'C4');
            state.currentTrade = { botOffer: [], playerOffer: [] };
            const offerSize = Math.floor(Math.random() * MAX_TRADE_SLOTS) + 1;
            for (let i = 0; i < offerSize; i++) {
                const randomPet = allPets[Math.floor(Math.random() * allPets.length)];
                state.currentTrade.botOffer.push({ ...randomPet, uniqueId: `bot-${i}-${Date.now()}`});
            }
            renderTradeUI();
        }
        function renderTradeUI() {
            ['botOfferGrid', 'playerOfferGrid'].forEach(gridId => {
                const grid = dom[gridId];
                grid.innerHTML = '';
                const isPlayerGrid = gridId === 'playerOfferGrid';
                const items = isPlayerGrid ? state.currentTrade.playerOffer : state.currentTrade.botOffer;
                
                items.forEach(item => {
                    const itemEl = createTradeItemElement(item, item.uniqueId);
                    if (isPlayerGrid) {
                        itemEl.addEventListener('click', () => moveItemToInventory(item.uniqueId));
                    }
                    grid.appendChild(itemEl);
                });

                for(let i = items.length; i < MAX_TRADE_SLOTS; i++) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'trade-item placeholder';
                    if (isPlayerGrid) {
                        placeholder.textContent = '+';
                        placeholder.addEventListener('click', openPetSelectionModal);
                    }
                    grid.appendChild(placeholder);
                }
            });
        }
        
        function openPetSelectionModal() {
            if (state.currentTrade.playerOffer.length >= MAX_TRADE_SLOTS) return;
            playSound('click', 'D4');
            dom.petSelectionGrid.innerHTML = '';
            const playerPets = state.collectedItems.filter(item => item.type === 'animal' || item.type === 'bug');
            const offeredIds = state.currentTrade.playerOffer.map(p => p.uniqueId);
            const availablePets = playerPets.filter(p => !offeredIds.includes(p.uniqueId));
            
            if (availablePets.length === 0) {
                dom.petSelectionGrid.innerHTML = '<p class="col-span-full text-center text-stone-400 text-sm">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞.</p>';
            } else {
                availablePets.forEach(item => {
                    const itemEl = createTradeItemElement(item, item.uniqueId);
                    itemEl.classList.add('h-28');
                    itemEl.addEventListener('click', () => {
                        moveItemToOffer(item.uniqueId);
                        closeModal(dom.petSelectionModal);
                    });
                    dom.petSelectionGrid.appendChild(itemEl);
                });
            }
            dom.petSelectionModal.classList.remove('hidden');
            dom.petSelectionModal.classList.add('flex');
        }

        function moveItemToOffer(uniqueId) {
            if (state.currentTrade.playerOffer.length >= MAX_TRADE_SLOTS) return;
            const itemIndex = state.collectedItems.findIndex(p => p.uniqueId === uniqueId);
            if (itemIndex > -1) {
                const item = state.collectedItems[itemIndex];
                const isAlreadyOffered = state.currentTrade.playerOffer.some(p => p.uniqueId === uniqueId);
                if (!isAlreadyOffered) {
                    state.currentTrade.playerOffer.push(item);
                    playSound('click', 'C5');
                    renderTradeUI();
                }
            }
        }
        function moveItemToInventory(uniqueId) {
            const itemIndex = state.currentTrade.playerOffer.findIndex(p => p.uniqueId === uniqueId);
            if (itemIndex > -1) {
                state.currentTrade.playerOffer.splice(itemIndex, 1);
                playSound('click', 'E4');
                renderTradeUI();
            }
        }
        function evaluateTrade() {
            if (state.currentTrade.playerOffer.length === 0) { 
                alert("–í—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–∏—Ç–æ–º—Ü–∞."); 
                return; 
            }
            playSound('trade', 'E4');
            const botValue = state.currentTrade.botOffer.reduce((sum, item) => sum + getItemValue(item), 0);
            const playerValue = state.currentTrade.playerOffer.reduce((sum, item) => sum + getItemValue(item), 0);
            const percentage = playerValue > 0 ? ((botValue / playerValue) - 1) * 100 : (botValue > 0 ? 1000 : 0);
            dom.tradeResultDetails.textContent = `–ë–æ—Ç: ${botValue.toFixed(0)} | –í—ã: ${playerValue.toFixed(0)}`;
            if (percentage > 5) {
                dom.tradeResultTitle.textContent = "–í–´–ì–û–î–ê!";
                dom.tradeResultPercentage.className = 'text-3xl font-bold text-green-400';
                dom.tradeResultPercentage.textContent = `+${percentage.toFixed(0)}%`;
            } else if (percentage < -5) {
                dom.tradeResultTitle.textContent = "–ü–û–¢–ï–†–Ø!";
                dom.tradeResultPercentage.className = 'text-3xl font-bold text-red-400';
                dom.tradeResultPercentage.textContent = `${percentage.toFixed(0)}%`;
            } else {
                dom.tradeResultTitle.textContent = "–†–ê–í–ù–´–ô –û–ë–ú–ï–ù";
                dom.tradeResultPercentage.className = 'text-3xl font-bold';
                dom.tradeResultPercentage.textContent = `${percentage > 0 ? '+' : ''}${percentage.toFixed(0)}%`;
            }
            dom.confirmTradeButton.classList.remove('hidden');
            dom.backToTradeButton.classList.remove('hidden');
            dom.closeTradeResultButton.classList.add('hidden');
            dom.tradeResultModal.classList.remove('hidden');
            dom.tradeResultModal.classList.add('flex');
        }
        function finalizeTrade() {
            playSound('win', 'C5');
            const offeredIds = state.currentTrade.playerOffer.map(p => p.uniqueId);
            state.collectedItems = state.collectedItems.filter(item => !offeredIds.includes(item.uniqueId));
            state.currentTrade.botOffer.forEach(item => addItemToInventory(item));
            saveInventory();
            renderCollectedInventories();
            dom.tradeResultTitle.textContent = "–£—Å–ø–µ—Ö!";
            dom.tradeResultDetails.textContent = "–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –æ–±–Ω–æ–≤–ª–µ–Ω.";
            dom.tradeResultPercentage.textContent = "‚úÖ";
            dom.confirmTradeButton.classList.add('hidden');
            dom.backToTradeButton.classList.add('hidden');
            dom.closeTradeResultButton.classList.remove('hidden');
        }
        
        function openInfoModal(itemId) {
            const container = allItemData[itemId];
            if (!container || !container.items) return;
            playSound('click', 'F4');
            dom.infoModalTitle.textContent = `–°–æ–¥–µ—Ä–∂–∏–º–æ–µ: ${container.name}`;
            dom.infoModalGrid.innerHTML = '';
            const sortedDrops = [...container.items].sort((a,b) => b.chance - a.chance);
            sortedDrops.forEach(drop => {
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item p-1 rounded-md flex flex-col items-center justify-between text-center h-28 bg-black bg-opacity-20';
                itemEl.innerHTML = `
                    <img src="${drop.image}" alt="${drop.name}" class="h-14 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/80x80/a1887f/FFF?text=?';">
                    <p class="text-[10px] font-bold leading-tight">${drop.name}</p>
                    <p class="text-[9px] ${drop.rarityClass}">[${drop.rarity}]</p>
                    <p class="text-[9px] font-bold text-amber-300">${drop.chance}%</p>`;
                dom.infoModalGrid.appendChild(itemEl);
            });

            dom.infoModal.classList.remove('hidden');
            dom.infoModal.classList.add('flex');
        }

        function populateInitialUI() {
            dom.inventoryGrid.innerHTML = '';
            Object.values(allItemData).forEach(container => {
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item p-1 rounded-lg text-center h-32 relative flex-shrink-0';
                itemEl.style.width = '120px';

                const infoBtn = document.createElement('div');
                infoBtn.className = 'info-button';
                infoBtn.textContent = 'i';
                infoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openInfoModal(container.id);
                });

                const mainBody = document.createElement('div');
                mainBody.className = 'w-full h-full flex flex-col items-center justify-start pt-1';
                mainBody.style.cursor = 'pointer';
                mainBody.addEventListener('click', () => handleSingleOpen(container.id));
                
                mainBody.innerHTML = `
                    <img src="${container.image}" alt="${container.name}" class="h-16 object-contain my-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/a1887f/FFF?text=?';">
                    <div class="flex-grow flex flex-col justify-center overflow-hidden w-full px-1">
                        <p class="text-xs font-bold leading-tight break-words">${container.name}</p>
                        <p class="text-[10px] ${container.rarityClass}">[${container.rarity}]</p>
                    </div>
                `;

                itemEl.appendChild(mainBody);
                itemEl.appendChild(infoBtn);
                dom.inventoryGrid.appendChild(itemEl);
            });

            dom.bulkOpenSelect.innerHTML = '';
            Object.values(allItemData).forEach(container => {
                const option = document.createElement('option');
                option.value = container.id;
                option.textContent = container.name;
                dom.bulkOpenSelect.appendChild(option);
            });
        }
        function setupEventListeners() {
            document.addEventListener('click', () => { if (Tone.context.state !== 'running') { try { Tone.start(); } catch(e) {} } }, { once: true });
            
            dom.bulkOpenButton.addEventListener('click', () => {
                const type = dom.bulkOpenSelect.value;
                const quantity = parseInt(dom.bulkQuantityInput.value, 10);
                if (isNaN(quantity) || quantity <= 0) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.'); return; }
                playSound('click', 'C4');
                setInventoryState(true);
                const itemContainer = allItemData[type];
                if (!itemContainer) return;
                for (let i = 0; i < quantity; i++) {
                    const wonItem = getRandomItem(itemContainer.items);
                    addItemToInventory(wonItem);
                }
                saveInventory();
                renderCollectedInventories();
                setTimeout(() => { setInventoryState(false); playSound('win', 'C5'); }, 200);
            });
            
            dom.skipButton.addEventListener('click', skipAnimation);
            dom.closeModalButton.addEventListener('click', () => closeModal(dom.resultModal));
            dom.resultModal.addEventListener('click', (e) => { if (e.target === dom.resultModal) closeModal(dom.resultModal); });

            dom.clearInventoryButton.addEventListener('click', () => {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                    playSound('clear', 'C3');
                    state.collectedItems = [];
                    saveInventory();
                    renderCollectedInventories();
                }
            });

            function handleDelete(e, grid) {
                 if (e.target.classList.contains('delete-item-button')) {
                    const itemName = e.target.dataset.itemName;
                    if (confirm(`–£–¥–∞–ª–∏—Ç—å –æ–¥–∏–Ω ${itemName}?`)) {
                        playSound('delete', 'C2');
                        const itemIndex = state.collectedItems.findIndex(i => i.name === itemName);
                        if (itemIndex > -1) state.collectedItems.splice(itemIndex, 1);
                        saveInventory();
                        renderCollectedInventories();
                    }
                }
            }
            dom.collectedPetsGrid.addEventListener('click', (e) => handleDelete(e, dom.collectedPetsGrid));
            dom.collectedSeedsGrid.addEventListener('click', (e) => handleDelete(e, dom.collectedSeedsGrid));


            dom.soundToggle.addEventListener('click', () => {
                state.isMuted = !state.isMuted;
                Tone.Destination.mute = state.isMuted;
                dom.soundToggle.textContent = state.isMuted ? 'üîá' : 'üîä';
            });
            
            dom.openTradeSimButton.addEventListener('click', () => { playSound('open', 'C4'); dom.tradeModal.classList.remove('hidden'); dom.tradeModal.classList.add('flex'); startNewTrade(); });
            dom.closeTradeModalButton.addEventListener('click', () => closeModal(dom.tradeModal));
            dom.declineTradeButton.addEventListener('click', startNewTrade);
            dom.acceptTradeButton.addEventListener('click', evaluateTrade);
            dom.backToTradeButton.addEventListener('click', () => { dom.tradeResultModal.classList.add('hidden'); dom.tradeResultModal.classList.remove('flex'); });
            dom.confirmTradeButton.addEventListener('click', finalizeTrade);
            dom.closeTradeResultButton.addEventListener('click', () => { dom.tradeResultModal.classList.add('hidden'); dom.tradeResultModal.classList.remove('flex'); startNewTrade(); });
            
            dom.closePetSelectionModalButton.addEventListener('click', () => closeModal(dom.petSelectionModal));
            dom.petSelectionModal.addEventListener('click', (e) => { if (e.target === dom.petSelectionModal) closeModal(dom.petSelectionModal); });
            dom.closeInfoModalButton.addEventListener('click', () => closeModal(dom.infoModal));
            dom.infoModal.addEventListener('click', (e) => { if (e.target === dom.infoModal) closeModal(dom.infoModal); });

            dom.showPetsBtn.addEventListener('click', () => {
                state.activeInventory = 'pets';
                dom.collectedPetsGrid.classList.remove('hidden');
                dom.collectedSeedsGrid.classList.add('hidden');
                dom.showPetsBtn.classList.add('active');
                dom.showSeedsBtn.classList.remove('active');
                playSound('click', 'C4');
            });
            dom.showSeedsBtn.addEventListener('click', () => {
                state.activeInventory = 'seeds';
                dom.collectedPetsGrid.classList.add('hidden');
                dom.collectedSeedsGrid.classList.remove('hidden');
                dom.showPetsBtn.classList.remove('active');
                dom.showSeedsBtn.classList.add('active');
                playSound('click', 'C4');
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadInventory();
            populateInitialUI();
            setupSounds();
            setupEventListeners();
        });
    </script>
</body>
</html>
