<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAGzenSimulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #3d5a55;
            color: #ffffff;
            text-shadow: 2px 2px #000000;
        }
        .inventory-container {
            background-color: #795548;
            border: 6px solid #4e342e;
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .action-button, .skip-button, .close-button, .clear-button, .simulate-button {
            transition: all 0.2s ease;
            border-radius: 8px;
            text-shadow: 1px 1px #000;
        }
        .action-button:hover, .skip-button:hover, .close-button:hover, .clear-button:hover, .simulate-button:hover {
             filter: brightness(1.1);
        }
        .action-button:active, .skip-button:active, .close-button:active, .clear-button:active, .simulate-button:active {
            transform: translateY(2px);
        }
        .skip-button, .clear-button {
            background-color: #f44336;
            color: white;
            border: 3px solid #d32f2f;
            border-bottom-width: 6px;
        }
        .skip-button:active, .clear-button:active { border-bottom-width: 3px; }
        .close-button {
            background-color: #2196F3;
            color: white;
            border: 3px solid #1976D2;
            border-bottom-width: 6px;
        }
        .close-button:active { border-bottom-width: 3px; }
        .simulate-button {
            background-color: #4CAF50;
            color: white;
            border: 3px solid #388E3C;
            border-bottom-width: 6px;
        }
        .simulate-button:active { border-bottom-width: 3px; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); }
        .modal-content { background-color: #795548; border: 6px solid #4e342e; }
        
        @keyframes rainbow-animation {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes divine-animation {
            0% { color: #00ffff; text-shadow: 0 0 10px #00ffff, 0 0 20px #fff; }
            50% { color: #ffffff; text-shadow: 0 0 15px #fff, 0 0 25px #00ffff; }
            100% { color: #00ffff; text-shadow: 0 0 10px #00ffff, 0 0 20px #fff; }
        }

        .rarity-Divine { animation: divine-animation 2s linear infinite; }
        .rarity-Prismatic {
            background: linear-gradient(90deg, #ff6666, #ffff66, #66ff66, #66ffff, #6666ff, #ff66ff, #ff6666);
            background-size: 400% auto;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-animation 4s linear infinite;
            text-shadow: none;
        }
        .rarity-Mythical { color: #FF00FF; text-shadow: 1px 1px #000, 0 0 10px #FF00FF; }
        .rarity-Legendary { color: #FFD700; text-shadow: 1px 1px #000, 0 0 8px #FFD700; }
        .rarity-Epic { color: #00BFFF; text-shadow: 1px 1px #000, 0 0 8px #00BFFF; }
        .rarity-Rare { color: #32CD32; text-shadow: 1px 1px #000; }
        .rarity-Uncommon { color: #FFFFFF; text-shadow: 1px 1px #000; }

        .roulette-container {
            overflow: hidden; position: relative; width: 100%; height: 180px;
            background-color: #a1887f; border: 4px solid #4e342e; padding: 10px 0;
        }
        .roulette-pointer {
            position: absolute; top: -4px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 20px solid transparent;
            border-right: 20px solid transparent; border-top: 25px solid #e91e63;
            z-index: 10; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.7));
        }
        .roulette-track { display: flex; height: 100%; }
        .roulette-item {
            flex-shrink: 0; width: 140px; height: 100%; margin: 0 10px;
            background-color: #d7ccc8; border: 4px solid #8d6e63; color: #3e2723;
            text-shadow: none; display: flex; flex-direction: column; align-items: center;
            justify-content: space-around; border-radius: 8px; font-size: 0.7rem;
            text-align: center; transition: transform 0.3s ease; padding: 4px;
        }
        .roulette-track.active .roulette-item.winner {
            transform: scale(1.15); background-color: #fffde7; border-color: #FFD700;
        }
        .roulette-item img { max-height: 80px; object-fit: contain; }
        .inventory-item {
             position: relative;
             background-color: #a1887f; border: 4px solid #4e342e;
             cursor: pointer; transition: all 0.2s ease; opacity: 1;
        }
        .inventory-item:hover { transform: scale(1.05); border-color: #c7a500; }
        .inventory-item.disabled { cursor: not-allowed; opacity: 0.5; }
        .item-count {
            position: absolute; bottom: 2px; right: 4px;
            font-size: 0.8rem; font-weight: bold;
            text-shadow: 1px 1px 2px #000, -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000;
        }
        .info-button {
            position: absolute; top: 5px; right: 5px; width: 24px; height: 24px;
            background-color: #2196F3; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; cursor: help; border: 2px solid white; z-index: 10;
        }
        .delete-item-button {
            position: absolute; top: 5px; left: 5px; width: 24px; height: 24px;
            background-color: #f44336; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; line-height: 1rem; font-weight: bold; cursor: pointer;
            border: 2px solid white; z-index: 11; opacity: 0; transition: opacity 0.2s;
        }
        .inventory-item:hover .delete-item-button { opacity: 1; }
        #sound-toggle {
            position: fixed; top: 20px; right: 20px;
            font-size: 2rem; cursor: pointer; z-index: 100;
        }
        .quantity-input {
            width: 100px; background-color: #d7ccc8; color: #3e2723;
            border: 2px solid #8d6e63; border-radius: 6px; text-align: center;
            padding: 4px; font-size: 1rem; text-shadow: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <div id="sound-toggle">üîä</div>

    <div class="max-w-7xl mx-auto">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-8">–°–∏–º—É–ª—è—Ç–æ—Ä zen GAG</h1>
        
        <div class="inventory-container p-6 rounded-lg mb-8">
            <h2 class="text-xl font-bold mb-4 text-center border-b-4 border-b-stone-800 pb-2">–ò–ù–í–ï–ù–¢–ê–†–¨</h2>
            <div id="inventory-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <div id="egg-item" class="inventory-item p-4 rounded-lg flex flex-col items-center justify-center text-center">
                    <div class="info-button" data-type="egg">i</div>
                    <img src="https://static.wikia.nocookie.net/growagarden/images/1/14/Zeneg.png/revision/latest?cb=20250720093353" alt="Zen Egg" class="h-24 object-contain mb-2">
                    <p class="text-sm font-bold">Zen Egg</p>
                    <p class="text-xs rarity-Legendary">[Legendary]</p>
                </div>
                <div id="seed-pack-item" class="inventory-item p-4 rounded-lg flex flex-col items-center justify-center text-center">
                     <div class="info-button" data-type="seed">i</div>
                    <img src="https://static.wikia.nocookie.net/growagarden/images/8/85/ExoticZenSeedPack.png/revision/latest?cb=20250719115944" alt="Exotic Zen Seed Pack" class="h-24 object-contain mb-2">
                    <p class="text-sm font-bold">Exotic Zen Seed Pack</p>
                    <p class="text-xs rarity-Rare">[Rare]</p>
                </div>
            </div>
        </div>

        <div class="inventory-container p-6 rounded-lg mb-8">
            <h2 class="text-xl font-bold mb-4 text-center border-b-4 border-b-stone-800 pb-2">–ú–ê–°–°–û–í–û–ï –û–¢–ö–†–´–¢–ò–ï</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                <div class="flex flex-col items-center gap-3">
                    <p class="font-bold">Zen Egg</p>
                    <input type="number" id="egg-quantity" class="quantity-input" value="10" min="1" max="10000">
                    <button id="simulate-egg-button" class="simulate-button px-4 py-2">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
                <div class="flex flex-col items-center gap-3">
                    <p class="font-bold">Exotic Zen Seed Pack</p>
                    <input type="number" id="seed-quantity" class="quantity-input" value="10" min="1" max="10000">
                    <button id="simulate-seed-button" class="simulate-button px-4 py-2">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="inventory-container p-6 rounded-lg mb-8">
            <div class="flex justify-between items-center border-b-4 border-b-stone-800 pb-2 mb-4">
                <h2 class="text-xl font-bold">–ü–û–õ–£–ß–ï–ù–ù–´–ï –ü–†–ï–î–ú–ï–¢–´</h2>
            </div>
            <div id="collected-inventory-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 min-h-[120px]">
            </div>
        </div>

        <div class="text-center mt-8">
            <button id="clear-inventory-button" class="clear-button py-2 px-6">–û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="result-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div id="modal-content" class="modal-content w-full max-w-2xl p-6 rounded-lg text-center relative">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <div id="roulette-view" class="hidden">
                <div class="roulette-container"><div class="roulette-pointer"></div><div id="roulette-track" class="roulette-track"></div></div>
            </div>
            <div id="simple-result-view" class="hidden my-8 flex justify-center"><div id="result-image-container" class="w-48 h-48"></div></div>
            <div id="controls-and-result-area" class="mt-4 min-h-[120px] flex flex-col justify-center items-center">
                <div id="final-result-display" class="hidden w-full">
                     <p id="result-name" class="text-2xl font-bold mb-2"></p>
                     <p id="result-rarity" class="text-lg font-semibold mb-6"></p>
                     <button id="close-modal-button" class="close-button font-bold py-2 px-6">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                <button id="skip-button" class="skip-button font-bold py-2 px-6 hidden">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-content w-full max-w-3xl p-6 rounded-lg text-center relative">
            <h2 id="info-modal-title" class="text-xl font-bold mb-6">–®–∞–Ω—Å—ã –ü—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
            <div id="info-modal-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto"></div>
            <button id="close-info-modal-button" class="close-button font-bold py-2 px-6 mt-6">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>


    <script>
        // --- DATA ---
        const eggItems = [
            { name: 'Shiba Inu', type: 'animal', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/b/bb/Shiba_Inu.png/revision/latest?cb=20250719022616' },
            { name: 'Nihonzaru', type: 'animal', chance: 31, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/d/db/Nihonzaru_.png/revision/latest?cb=20250719022615' },
            { name: 'Tanuki', type: 'animal', chance: 20.82, rarity: 'Epic', rarityClass: 'rarity-Epic', image: 'https://static.wikia.nocookie.net/growagarden/images/1/1f/Tanuki_.png/revision/latest?cb=20250719022618' },
            { name: 'Tanchozuru', type: 'animal', chance: 4.6, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/d/d3/Tanchozuru_.png/revision/latest?cb=20250719022617' },
            { name: 'Kappa', type: 'animal', chance: 3.5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/8/84/Kappa_.png/revision/latest?cb=20250719022611' },
            { name: 'Kitsune', type: 'animal', chance: 0.08, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/4/4d/Kitsune_.png/revision/latest?cb=20250719022612' }
        ];
        const seedItems = [
            { name: 'Monoblooma', type: 'seed', chance: 40, rarity: 'Uncommon', rarityClass: 'rarity-Uncommon', image: 'https://static.wikia.nocookie.net/growagarden/images/a/ad/MonobloomaCrop.png/revision/latest?cb=20250719120840' },
            { name: 'Serenity', type: 'seed', chance: 25, rarity: 'Rare', rarityClass: 'rarity-Rare', image: 'https://static.wikia.nocookie.net/growagarden/images/d/d9/SerenityCrop.png/revision/latest?cb=20250719120857' },
            { name: 'Taro Flower', type: 'seed', chance: 20, rarity: 'Epic', rarityClass: 'rarity-Epic', image: 'https://static.wikia.nocookie.net/growagarden/images/a/a1/TaroFlowerCrop.png/revision/latest?cb=20250719120911' },
            { name: 'Zen Rocks', type: 'seed', chance: 10, rarity: 'Legendary', rarityClass: 'rarity-Legendary', image: 'https://static.wikia.nocookie.net/growagarden/images/c/c9/ZenRocksCrop.png/revision/latest?cb=20250719120925' },
            { name: 'Hinomai', type: 'seed', chance: 4.5, rarity: 'Mythical', rarityClass: 'rarity-Mythical', image: 'https://static.wikia.nocookie.net/growagarden/images/4/41/HinomaiCrop.png/revision/latest?cb=20250719120939' },
            { name: 'Maple Apple', type: 'seed', chance: 0.5, rarity: 'Prismatic', rarityClass: 'rarity-Prismatic', image: 'https://static.wikia.nocookie.net/growagarden/images/7/7f/MapleAppleCrop.png/revision/latest?cb=20250719120733' }
        ];

        // --- DOM ELEMENTS ---
        const eggItemEl = document.getElementById('egg-item');
        const seedPackItemEl = document.getElementById('seed-pack-item');
        const modal = document.getElementById('result-modal');
        const modalTitle = document.getElementById('modal-title');
        const skipButton = document.getElementById('skip-button');
        const rouletteView = document.getElementById('roulette-view');
        const rouletteTrack = document.getElementById('roulette-track');
        const simpleResultView = document.getElementById('simple-result-view');
        const resultImageContainer = document.getElementById('result-image-container');
        const finalResultDisplay = document.getElementById('final-result-display');
        const resultName = document.getElementById('result-name');
        const resultRarity = document.getElementById('result-rarity');
        const closeModalButton = document.getElementById('close-modal-button');
        const collectedInventoryGrid = document.getElementById('collected-inventory-grid');
        const clearInventoryButton = document.getElementById('clear-inventory-button');
        const soundToggle = document.getElementById('sound-toggle');
        const infoModal = document.getElementById('info-modal');
        const infoModalTitle = document.getElementById('info-modal-title');
        const infoModalGrid = document.getElementById('info-modal-grid');
        const closeInfoModalButton = document.getElementById('close-info-modal-button');
        const infoButtons = document.querySelectorAll('.info-button');
        const eggQuantityInput = document.getElementById('egg-quantity');
        const seedQuantityInput = document.getElementById('seed-quantity');
        const simulateEggButton = document.getElementById('simulate-egg-button');
        const simulateSeedButton = document.getElementById('simulate-seed-button');

        // --- STATE ---
        let winningItem = null;
        let animationTimeoutId = null;
        let isOpening = false;
        let collectedItems = [];
        let isMuted = true;

        // --- SOUNDS ---
        let clickSound, openSound, closeSound, clearSound, tickSound, winSound, deleteSound;
        let spinLoop;

        function setupSounds() {
            clickSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 0.1 } }).toDestination();
            openSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination();
            closeSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
            clearSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination();
            deleteSound = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0 } }).toDestination();
            deleteSound.volume.value = -10;
            tickSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.01 } }).toDestination();
            tickSound.volume.value = -12;
            winSound = new Tone.MetalSynth({ frequency: 250, envelope: { attack: 0.001, decay: 0.6, release: 0.2 }, harmonicity: 6.1, modulationIndex: 28, resonance: 3500, octaves: 1.5 }).toDestination();
            winSound.volume.value = -6;
            Tone.Destination.mute = isMuted;
            soundToggle.textContent = isMuted ? 'üîá' : 'üîä';
        }
        
        function playSound(sound, note, duration = '8n', time = '+0') {
            if (isMuted || !sound) return;
            sound.triggerAttackRelease(note, duration, Tone.now() + time);
        }

        function playWinSound(rarity) {
             if (isMuted) return;
             const now = Tone.now();
             let note = 'C5', vol = -8;
             switch(rarity) {
                case 'Divine': note = 'C7'; vol = -2; break;
                case 'Prismatic': note = 'G6'; vol = -4; break;
                case 'Mythical': note = 'A5'; vol = -6; break;
                case 'Legendary': note = 'G5'; vol = -8; break;
                case 'Epic': note = 'E5'; vol = -10; break;
                case 'Rare': note = 'C5'; vol = -12; break;
                default: note = 'A4'; vol = -14;
             }
             winSound.volume.value = vol;
             winSound.triggerAttackRelease(note, '0.5', now);
        }

        // --- INVENTORY FUNCTIONS ---
        function saveInventory() {
            localStorage.setItem('gagluck_collectedItems', JSON.stringify(collectedItems));
        }

        function loadInventory() {
            const saved = localStorage.getItem('gagluck_collectedItems');
            if (saved) {
                collectedItems = JSON.parse(saved);
            }
            renderCollectedInventory();
        }

        function renderCollectedInventory() {
            collectedInventoryGrid.innerHTML = '';
            if (collectedItems.length === 0) {
                 collectedInventoryGrid.innerHTML = '<p class="col-span-full text-center text-stone-300">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>';
                 return;
            }
            const sortedItems = [...collectedItems].sort((a, b) => {
                const rarityOrder = ['Uncommon', 'Rare', 'Epic', 'Legendary', 'Mythical', 'Prismatic', 'Divine'];
                return rarityOrder.indexOf(b.rarity) - rarityOrder.indexOf(a.rarity) || a.name.localeCompare(b.name);
            });

            sortedItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item p-2 rounded-lg flex flex-col items-center justify-between text-center h-40 bg-opacity-50';
                itemEl.innerHTML = `
                    <div class="delete-item-button" data-item-name="${item.name}">√ó</div>
                    <img src="${item.image}" alt="${item.name}" class="h-20 object-contain mb-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/795548/FFF?text=?';">
                    <p class="text-xs font-bold leading-tight">${item.name}</p>
                    <p class="text-xs ${item.rarityClass}">[${item.rarity}]</p>
                    ${item.count > 1 ? `<div class="item-count">x${item.count}</div>` : ''}
                `;
                collectedInventoryGrid.appendChild(itemEl);
            });
        }

        function clearInventory() {
            playSound(clearSound, 'C3', '0.3');
            collectedItems = [];
            saveInventory();
            renderCollectedInventory();
        }

        function deleteSingleItem(itemName) {
            if (isMuted) deleteSound.triggerAttackRelease("8n");
            const itemIndex = collectedItems.findIndex(i => i.name === itemName);
            if (itemIndex > -1) {
                if (collectedItems[itemIndex].count > 1) {
                    collectedItems[itemIndex].count--;
                } else {
                    collectedItems.splice(itemIndex, 1);
                }
            }
            saveInventory();
            renderCollectedInventory();
        }

        // --- CORE FUNCTIONS ---
        function addItemToInventory(item) {
            const existingItem = collectedItems.find(i => i.name === item.name);
            if (existingItem) {
                existingItem.count = (existingItem.count || 1) + 1;
            } else {
                collectedItems.push({ ...item, count: 1 });
            }
        }

        function getRandomItem(items) {
            const totalChance = items.reduce((sum, item) => sum + item.chance, 0);
            let random = Math.random() * totalChance;
            for (const item of items) {
                if (random < item.chance) return item;
                random -= item.chance;
            }
            return items[items.length - 1];
        }

        function setInventoryState(disabled) {
            isOpening = disabled;
            eggItemEl.classList.toggle('disabled', disabled);
            seedPackItemEl.classList.toggle('disabled', disabled);
        }

        function showFinalResult(item) {
            playWinSound(item.rarity);
            addItemToInventory(item);
            saveInventory();
            renderCollectedInventory();
            
            resultName.textContent = item.name;
            resultRarity.innerHTML = `[${item.rarity}]`;
            resultRarity.className = `text-lg font-semibold ${item.rarityClass}`;
            skipButton.classList.add('hidden');
            finalResultDisplay.classList.remove('hidden');
        }
        
        function closeModal() {
            playSound(closeSound, 'A3', '0.1');
            modal.classList.add('hidden');
            setInventoryState(false);
            clearTimeout(animationTimeoutId);
            Tone.Transport.stop();
            if(spinLoop) spinLoop.cancel(0);
            if(rouletteTrack) rouletteTrack.style.transition = 'none';
        }
        
        function handleSingleOpen(type) {
            if (isOpening) return;
            playSound(clickSound, 'C5', '0.1');
            setInventoryState(true);

            const items = type === 'egg' ? eggItems : seedItems;
            winningItem = getRandomItem(items);
            
            if (type === 'egg') {
                modalTitle.textContent = "Zen Egg";
                rouletteView.classList.add('hidden');
                simpleResultView.classList.remove('hidden');
                resultImageContainer.innerHTML = `<img src="${winningItem.image}" alt="${winningItem.name}" class="w-full h-full object-contain">`;
                finalResultDisplay.classList.add('hidden');
                modal.classList.remove('hidden');
                playSound(openSound, 'E5', '0.2');
                animationTimeoutId = setTimeout(() => { if (isOpening) showFinalResult(winningItem); }, 800);
            } else { // Seed Pack
                let trackItems = [];
                const trackLength = 50;
                for (let i = 0; i < trackLength; i++) { trackItems.push(getRandomItem(seedItems)); }
                const winnerIndex = trackLength - 6;
                trackItems[winnerIndex] = winningItem;

                rouletteTrack.innerHTML = '';
                rouletteTrack.style.transform = 'translateX(0px)';
                rouletteTrack.classList.remove('active');
                trackItems.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'roulette-item';
                    if (index === winnerIndex) itemElement.classList.add('winner');
                    itemElement.innerHTML = `<img src="${item.image}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/795548/FFF?text=?';"><div class="name">${item.name}</div><div class="font-bold ${item.rarityClass}">${item.chance}%</div>`;
                    rouletteTrack.appendChild(itemElement);
                });

                modalTitle.textContent = "Exotic Zen Seed Pack";
                simpleResultView.classList.add('hidden');
                rouletteView.classList.remove('hidden');
                finalResultDisplay.classList.add('hidden');
                skipButton.classList.remove('hidden');
                modal.classList.remove('hidden');
                playSound(openSound, 'E5', '0.2');
                
                Tone.Transport.stop();
                Tone.Transport.cancel();
                spinLoop = new Tone.Loop(time => { tickSound.triggerAttack('C2', time); }, '16n').start(0);
                Tone.Transport.bpm.value = 280;
                Tone.Transport.start();
                Tone.Transport.bpm.rampTo(40, 4.5);

                setTimeout(() => {
                    const itemWidth = 140, itemMargin = 20;
                    const containerWidth = rouletteView.offsetWidth;
                    const centerOffset = containerWidth / 2;
                    const itemCenterOffset = (itemWidth / 2) + 10;
                    const randomOffset = (Math.random() - 0.5) * (itemWidth * 0.8);
                    const targetPosition = (winnerIndex * (itemWidth + itemMargin)) + itemCenterOffset - centerOffset + randomOffset;
                    rouletteTrack.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                    rouletteTrack.style.transform = `translateX(-${targetPosition}px)`;
                    animationTimeoutId = setTimeout(() => {
                        Tone.Transport.stop();
                        if(spinLoop) spinLoop.cancel(0);
                        rouletteTrack.classList.add('active');
                        setTimeout(() => { if(isOpening) showFinalResult(winningItem); }, 1500);
                    }, 5000);
                }, 100);
            }
        }

        function handleBulkOpen(type) {
            if (isOpening) return;
            const quantity = parseInt(type === 'egg' ? eggQuantityInput.value : seedQuantityInput.value, 10);
            if (isNaN(quantity) || quantity <= 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.');
                return;
            }
            
            playSound(clickSound, 'C4', '0.2');
            setInventoryState(true);
            
            const itemsToOpen = type === 'egg' ? eggItems : seedItems;
            
            // Simulate opening without animation
            for (let i = 0; i < quantity; i++) {
                const item = getRandomItem(itemsToOpen);
                addItemToInventory(item);
            }
            
            saveInventory();
            renderCollectedInventory();
            
            // Re-enable opening after a short delay
            setTimeout(() => {
                setInventoryState(false);
                playSound(clickSound, 'C5', '0.1');
            }, 200);
        }

        function skipAnimation() {
            if (!isOpening || !winningItem) return;
            playSound(clickSound, 'A4', '0.1');
            clearTimeout(animationTimeoutId);
            Tone.Transport.stop();
            if(spinLoop) spinLoop.cancel(0);
            if(rouletteTrack) rouletteTrack.style.transition = 'none';
            rouletteTrack.classList.add('active');
            showFinalResult(winningItem);
        }
        
        function showInfoModal(type) {
            const items = type === 'egg' ? eggItems : seedItems;
            const title = type === 'egg' ? '–®–∞–Ω—Å—ã –∏–∑ Zen Egg' : '–®–∞–Ω—Å—ã –∏–∑ Exotic Zen Seed Pack';
            infoModalTitle.textContent = title;
            infoModalGrid.innerHTML = '';
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-2 rounded-lg flex flex-col items-center text-center bg-black bg-opacity-20';
                itemEl.innerHTML = `<img src="${item.image}" alt="${item.name}" class="h-20 object-contain mb-2" onerror="this.onerror=null;this.src='https://placehold.co/100x100/795548/FFF?text=?';"><p class="text-xs font-bold">${item.name}</p><p class="text-xs ${item.rarityClass}">[${item.rarity}]</p><p class="text-sm font-bold mt-1">${item.chance}%</p>`;
                infoModalGrid.appendChild(itemEl);
            });
            infoModal.classList.remove('hidden');
        }

        function closeInfoModal() {
            playSound(closeSound, 'A3', '0.1');
            infoModal.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---
        eggItemEl.addEventListener('click', () => handleSingleOpen('egg'));
        seedPackItemEl.addEventListener('click', () => handleSingleOpen('seed'));
        simulateEggButton.addEventListener('click', () => handleBulkOpen('egg'));
        simulateSeedButton.addEventListener('click', () => handleBulkOpen('seed'));
        
        skipButton.addEventListener('click', skipAnimation);
        closeModalButton.addEventListener('click', closeModal);
        clearInventoryButton.addEventListener('click', clearInventory);
        modal.addEventListener('click', (event) => { if (event.target === modal) { closeModal(); } });
        
        infoButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                playSound(clickSound, 'C5', '0.1');
                showInfoModal(e.target.dataset.type);
            });
        });
        closeInfoModalButton.addEventListener('click', closeInfoModal);
        infoModal.addEventListener('click', (event) => { if (event.target === infoModal) { closeInfoModal(); } });

        collectedInventoryGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-item-button')) {
                const itemName = e.target.dataset.itemName;
                deleteSingleItem(itemName);
            }
        });

        soundToggle.addEventListener('click', () => {
            if (Tone.context.state !== 'running') { Tone.start(); }
            isMuted = !isMuted;
            Tone.Destination.mute = isMuted;
            soundToggle.textContent = isMuted ? 'üîá' : 'üîä';
        });

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
             loadInventory();
             setupSounds();
        });
    </script>
</body>
</html>
